<html>
<head>
    <style>
        #Player { transform-origin: center; transition: transform 0.1s; }
        .platform {
            background-color: green;
            position: absolute;
            box-sizing: border-box;
        }
        .powerup {
            filter: drop-shadow(0 0 10px gold);
            cursor: pointer;
            animation: hoverEffect 2s ease-in-out infinite;
        }
        @keyframes hoverEffect {
            0% { transform: translateY(0px); }
            50% { transform: translateY(-5px); }
            100% { transform: translateY(0px); }
        }
        #Scissors03 { filter: sepia(1) saturate(5) hue-rotate(-50deg); }
    </style>
</head>

<body id="myBody" style="background-repeat:repeat; background-size: 80%" background="sky.png">

    <h1 align="center"><font color="red">Level 3</font></h1>

    <img id="Player" src="Scissors.png" style="position:absolute; width:100px; height:80px; left:55px; top:300px;">

    <div class="platform" style="width:120px; height:10px; left:55px; top:420px;"></div>
    <div class="platform" style="width:90px; height:10px; left:430px; top:415px;"></div>
    <div class="platform" id="lowest-platform" style="width:90px; height:10px; left:320px; top:510px;"></div>
    <div class="platform" style="width:90px; height:10px; left:445px; top:270px;"></div>
    <div class="platform" style="width:90px; height:10px; left:695px; top:270px;"></div>
    <div class="platform" style="width:120px; height:10px; left:900px; top:650px;"></div>
    <div class="platform" style="width:140px; height:10px; left:1100px; top:650px;"></div>

    <img id="myRock01" class="powerup" src="rock.png" style="position:absolute; width:40px; height:40px; left:285px; top:470px;">
    <img id="Paper02" class="obstacle" src="paper.png" style="position:absolute; width:50px; height:70px; left:420px; top:230px;">
    <img id="Scissors03" class="obstacle" src="Scissors.png" style="position:absolute; width:100px; height:80px; left:740px; top:140px;">
    <img id="myWin01" src="yellow.png" style="position:absolute; width:50px; height:80px; left:1325px; top:590px;">
    <img id="myDeathBox03" src="red.png" style="position:absolute; width:100%; height:10px; left:0px; top:680px;">

<script>
    const config = { gravity: 0.5, jumpForce: -10, acceleration: 0.6, maxSpeed: 8, drag: 0.9 };
    let player, myVelocityX = 0, myVelocityY = 0, isGrounded = false;
    let playerState = 'scissors', paperExploded = false, scissorsExploded = false; 
    const keysDown = {};

    window.onload = function() {
        player = document.getElementById('Player');
        setHitboxes('scissors');
        window.addEventListener('keydown', e => keysDown[e.key.toLowerCase()] = true);
        window.addEventListener('keyup', e => keysDown[e.key.toLowerCase()] = false);
        setInterval(gameLoop, 20);
    };

    function setHitboxes(state) {
        player.hitboxes = (state === 'scissors') ? 
            [{ x: 70, y: 10, w: 20, h: 20 }, { x: 50, y: 25, w: 20, h: 20 }, { x: 30, y: 40, w: 20, h: 20 }, { x: 5, y: 55, w: 25, h: 27 }] : 
            [{ x: 0, y: 0, w: 100, h: 80 }];
    }

function getHitboxes(id) {
        const el = document.getElementById(id);
        if (!el || el.style.display === 'none' || el.style.opacity === '0') return [];
        const r = el.getBoundingClientRect();

        // Check if the object is the Player OR the Scissors Obstacle
        if (id === 'Player' || id.includes('Scissors')) {
            const isFlipped = el.style.transform.includes('scaleX(-1)');
            
            // Refined hitbox: Handle, Pivot, and Blades
            const subBoxes = [
                { x: 5, y: 45, w: 30, h: 30 },  // Handle area
                { x: 35, y: 30, w: 30, h: 25 }, // Center pivot
                { x: 65, y: 5, w: 30, h: 35 }   // Blade tips
            ];

            return subBoxes.map(box => {
                let posX = isFlipped ? (100 - box.x - box.w) : box.x;
                return { 
                    left: r.left + posX, 
                    top: r.top + box.y, 
                    right: r.left + posX + box.w, 
                    bottom: r.top + box.y + box.h, 
                    localBottom: box.y + box.h 
                };
            });
        }
        
        // Default box for rocks, paper, and platforms
        return [r]; 
    }

    function isTouching(id1, id2) {
        const boxes1 = getHitboxes(id1), boxes2 = getHitboxes(id2);
        for (let r1 of boxes1) for (let r2 of boxes2)
            if (r1.right > r2.left && r1.bottom > r2.top && r1.left < r2.right && r1.top < r2.bottom) return true;
        return false;
    }

    function gameLoop() {
        // Horizontal
        myVelocityX *= config.drag;
        if (keysDown['a']) { myVelocityX -= config.acceleration; player.style.transform = 'scaleX(1)'; } 
        if (keysDown['d']) { myVelocityX += config.acceleration; player.style.transform = 'scaleX(-1)'; }
        player.style.left = (parseFloat(player.style.left) || 0) + myVelocityX + 'px';

        // Vertical & Collision Fix
        myVelocityY += config.gravity;
        let nextTop = (parseFloat(player.style.top) || 0) + myVelocityY;
        let onPlatform = false;
        const playerBoxes = getHitboxes('Player');
        const platforms = document.querySelectorAll('.platform');

        if (myVelocityY >= 0) { 
            platforms.forEach(plat => {
                const pRect = plat.getBoundingClientRect();
                const pTop = parseFloat(plat.style.top);
                playerBoxes.forEach(box => {
                    if (box.right > pRect.left && box.left < pRect.right &&
                        box.bottom <= pTop && (box.bottom + myVelocityY) >= pTop) {
                        nextTop = pTop - box.localBottom;
                        myVelocityY = 0;
                        onPlatform = true;
                    }
                });
            });
        }

        player.style.top = nextTop + "px";
        isGrounded = onPlatform;
        if (keysDown['w'] && isGrounded) { myVelocityY = config.jumpForce; isGrounded = false; }

        // Logic
        if (isTouching('Player', 'myDeathBox03') || parseFloat(player.style.top) > 800) reset();
        if (isTouching('Player', 'myWin01')) alert("Level 3 Complete!");

        if (isTouching('Player', 'myRock01') && document.getElementById('myRock01').style.display !== 'none') {
            playerState = 'rock'; player.src = 'rock.png'; setHitboxes('rock');
            document.getElementById('myRock01').style.display = 'none';
        }

        if (isTouching('Player', 'Paper02')) {	
            if (playerState === 'rock') reset(); 
            else if (!paperExploded) {
                paperExploded = true;
                const p = document.getElementById('Paper02');
                p.src = 'explode.gif?t=' + Date.now(); 
                setTimeout(() => { p.style.display = 'none'; }, 1000);
            }
        }

        if (isTouching('Player', 'Scissors03') && playerState === 'rock' && !scissorsExploded) {
            scissorsExploded = true;
            const s = document.getElementById('Scissors03');
            s.src = 'explode.gif?t=' + Date.now();
            setTimeout(() => { s.style.display = 'none'; }, 1000);
        }
    }

    function reset() {
        player.style.left = '55px'; player.style.top = '300px';
        myVelocityX = 0; myVelocityY = 0;
        playerState = 'scissors'; player.src = 'Scissors.png'; setHitboxes('scissors');
        const p = document.getElementById('Paper02'); p.src = 'paper.png'; p.style.display = 'block'; paperExploded = false;
        const s = document.getElementById('Scissors03'); s.src = 'Scissors.png'; s.style.display = 'block'; scissorsExploded = false;
        document.getElementById('myRock01').style.display = 'block';
    }
</script>
</body>
</html>
