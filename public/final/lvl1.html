<!DOCTYPE html>
<html>
<head>
    <style>
        #Player { transform-origin: center; }
        #myGround04 { background-color: #836539; }
        
        /* The Blue Debug Boxes */
        .hitbox-visual {
            border: 1px solid rgba(0, 0, 255, 0.1); 
            position: absolute;
            pointer-events: none;
            z-index: 1000;
            box-sizing: border-box;
        }
    </style>
</head>

<body id="myBody" style="background-repeat:repeat; background-size: 80%" background="myBackground01.jpg">

    <h1 align="center"><font color="red">T4A04 Maze by Fred</font></h1>

    <img id="Player" src="Scissors.png" style="position:absolute; width:100px; height:80px; left: 50px; top:500px;">
    <img id="myPlatform02" src="green.png" class="platform" style="position:absolute; width:150px; height:20px; left:350px; top:400px;">
    <img id="myPlatform03" src="green.png" class="platform" style="position:absolute; width:150px; height:20px; left:550px; top:400px;">
    <img id="myPlatform03" src="green.png" class="platform" style="position:absolute; width:150px; height:20px; left:550px; top:400px;">
    <img id="myDeathBox03" src="red.png" style="position:absolute; width:50px; height:10px; left:500px; top:400px;">
    <img id="myWin01" src="yellow.png" style="position:absolute; width:100px; height:80px; left:800px; top:425px;">
    <img id="Paper02" src="paper.png" style="position:absolute; width:50px; height:70px; left: 600px; top:320px;">
    <div id="myGround04" style="position:absolute; width:100%; height:500px; left:0px; top:500px;"></div>

    <script>
        const config = {
            gravity: 0.5,
            jumpForce: -14,
            acceleration: 0.8,
            airAcceleration: 0.4,
            maxSpeed: 8,
            drag: 0.9,
            screenFloor: 500
        };

        let player;
        let myVelocityX = 0;
        let myVelocityY = 1;
        let isGrounded = true;
        const keysDown = {};
        let paperExploded = false;
        window.onload = function() {
            player = document.getElementById('Player');
            player.hitboxes = [
                { x: 70, y: 10, w: 20, h: 20 },
                { x: 50, y: 25, w: 20, h: 20 },
                { x: 30, y: 40, w: 20, h: 20 },
                { x: 5, y: 55, w: 25, h: 27 }
            ];

            player.hitboxes.forEach((box, index) => {
                let d = document.createElement('div');
                d.id = 'debug-' + index;
                d.className = 'hitbox-visual';
                document.body.appendChild(d);
            });

            window.addEventListener('keydown', e => keysDown[e.key.toLowerCase()] = true);
            window.addEventListener('keyup', e => keysDown[e.key.toLowerCase()] = false);
            setInterval(gameLoop, 20);
        };

        function getHitboxes(id) {
            const el = document.getElementById(id);
            if (!el) return [];
            const r = el.getBoundingClientRect();
            
            if (id === 'Player' && el.hitboxes) {
                const isFlipped = el.style.transform === 'scaleX(-1)';
                const imgWidth = 100;

                return el.hitboxes.map(box => {
                    let posX = isFlipped ? (imgWidth - box.x - box.w) : box.x;
                    return {
                        left: r.left + posX,
                        top: r.top + box.y,
                        right: r.left + posX + box.w,
                        bottom: r.top + box.y + box.h,
                        localBottom: box.y + box.h // New: keep track of box offset
                    };
                });
            }
            return [r]; 
        }

        function isTouching(id1, id2) {
            const boxes1 = getHitboxes(id1);
            const boxes2 = getHitboxes(id2);
            for (let r1 of boxes1) {
                for (let r2 of boxes2) {
                    if (r1.right > r2.left && r1.bottom > r2.top && r1.left < r2.right && r1.top < r2.bottom) return true;
                }
            }
            return false;
        }

function handlePhysics() {
    myVelocityX *= config.drag;
    const accel = isGrounded ? config.acceleration : config.airAcceleration;

    // Pressing 'a' (Left)
    if (keysDown['a']) { 
        myVelocityX -= accel; 
        player.style.transform = 'scaleX(1)';  // Changed from -1 to 1
    } 
    
    // Pressing 'd' (Right)
    if (keysDown['d']) { 
        myVelocityX += accel; 
        player.style.transform = 'scaleX(-1)'; // Changed from 1 to -1
    }
    
    if (Math.abs(myVelocityX) > config.maxSpeed) myVelocityX = myVelocityX > 0 ? config.maxSpeed : -config.maxSpeed;
    
    let currLeft = parseFloat(player.style.left) || 0;
    player.style.left = (currLeft + myVelocityX) + 'px';

    if (keysDown['w'] && isGrounded) {
        myVelocityY = config.jumpForce;
        isGrounded = false;
    }
}

function checkCollisions() {
    let onPlatform = false;
    let onFloor = false;
    let currTop = parseFloat(player.style.top) || 0;

    const playerBoxes = getHitboxes('Player');
    const allPlatforms = document.querySelectorAll('.platform');

    myVelocityY += config.gravity;

    // --- SMART PLATFORM COLLISION ---
    if (myVelocityY > 0) { 
        for (let plat of allPlatforms) {
            const pRect = plat.getBoundingClientRect();
            const pTop = parseInt(plat.style.top);
            
            for (let box of playerBoxes) {
                // ADDED THE { HERE
                if (box.right > pRect.left && box.left < pRect.right &&
                    box.bottom > pRect.top && box.top < pRect.top + 20) { // Added height check
                    
                    player.style.top = (pTop - box.localBottom - 0.1) + 'px';
                    myVelocityY = 0;
                    onPlatform = true;
                    break; 
                }
                // ADDED THE } HERE
            }
            if (onPlatform) break;
        }
    }

    // --- FLOOR COLLISION ---
    let maxBottomOffset = 0;
    player.hitboxes.forEach(b => {
        if (b.y + b.h > maxBottomOffset) maxBottomOffset = b.y + b.h;
    });

    if (!onPlatform) {
        let nextTop = currTop + myVelocityY;
        if (nextTop + maxBottomOffset >= config.screenFloor) {
            player.style.top = (config.screenFloor - maxBottomOffset) + "px";
            myVelocityY = 0;
            onFloor = true;
        } else {
            player.style.top = nextTop + "px";
        }
    }

    isGrounded = onPlatform || onFloor;
}
        function gameLoop() {
            handlePhysics();
            checkCollisions();
            
            // Sync Debug Visuals
            const currentHitboxes = getHitboxes('Player'); 
            currentHitboxes.forEach((box, index) => {
                const d = document.getElementById('debug-' + index);
                if (d) {
                    d.style.left = (box.left + window.scrollX) + 'px';
                    d.style.top = (box.top + window.scrollY) + 'px';
                    d.style.width = (box.right - box.left) + 'px';
                    d.style.height = (box.bottom - box.top) + 'px';
                }
            });

            if (isTouching('Player', 'myDeathBox03')) {reset(); }
            if (isTouching('Player', 'myWin01')) {reset(); }
if (isTouching('Player', 'Paper02') && !paperExploded) {
        const paper = document.getElementById('Paper02');
        paper.src = 'explode.gif';
        paperExploded = true;

        // The timer must stay inside this IF block
        setTimeout(() => {
            paper.style.opacity = '0'
        }, 1000)
    }
}

        function reset() {
            player.style.left = '50px'
            player.style.top = '350px'
            player.style.transform = 'scaleX(1)'

            myVelocityX = 0;
            myVelocityY = 0;

paperExploded = false;
            const paper = document.getElementById('Paper02');
            paper.src = 'paper.png';
            paper.style.opacity = '1';
        }
    </script>
</body>
</html>
