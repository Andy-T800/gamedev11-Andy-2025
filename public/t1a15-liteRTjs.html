<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>liteRTjs Classifier</title>

<!-- ‚úÖ Correct TF.js + TFLite -->
<script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@4.17.0"></script>
<script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs-tflite@0.0.1-alpha.9/dist/tf-tflite.min.js"></script>

<style>
  body {
    font-family: Inter, sans-serif;
    text-align: center;
    background: #f8faff;
    margin: 2em;
  }
  h1 { color: #3c4043; }
  #container {
    max-width: 500px;
    margin: auto;
    background: white;
    padding: 1em 2em;
    border-radius: 12px;
    box-shadow: 0 4px 10px rgba(0,0,0,0.1);
  }
  .group {
    margin: 1em 0;
    padding: 1em;
    border: 1px dashed #ccc;
    border-radius: 8px;
  }
  label { display:block; margin: 0.5em 0 0.2em; }
  input, select, textarea, button {
    width: 100%; padding: 0.5em; box-sizing: border-box;
    font-size: 14px; border-radius: 6px; border: 1px solid #dadce0;
  }
  button {
    background: #0f9d58; color: white; border: none;
    margin-top: 0.6em; cursor: pointer; font-weight: 600;
  }
  button:hover { background: #0c8045; }
  #startCamBtn { background: #1a73e8; }
  #resetBtn { background:#d93025; }
  canvas { border: 3px solid #0f9d58; border-radius: 8px; margin-top: 20px; }
  .status {
    background: #e6ffed; border: 1px solid #0f9d58; border-radius: 6px;
    padding: 0.8em; margin: 1em 0; font-weight: bold;
  }
</style>
</head>
<body>

<h1>liteRTjs Classifier</h1>
<div id="container">
  <div class="status" id="status">1. Configure ‚Üí 2. Load Model ‚Üí 3. Start Webcam</div>

  <div class="group">
    <label>Resolution (px):</label>
    <input type="number" id="res" value="120" min="32">
    <label>Color Channels:</label>
    <select id="ch"><option value="3">RGB</option><option value="1">Grayscale</option></select>
    <label>Display Threshold (0‚Äì1):</label>
    <input type="number" id="th" value="0.7" min="0" max="1" step="0.05">
    <label>Class Labels (comma-separated):</label>
    <input id="labels" value="background,brush,paint">
    <button id="applyBtn">Apply Config</button>
  </div>

  <div class="group">
    <label>Load Model (.tflite)</label>
    <input type="file" id="fileInput" accept=".tflite">
    <button id="defaultBtn">Load Default Model</button>
    <label>or Custom URL:</label>
    <input id="urlInput" value="tflite/ei-ei-jeremy-0unknown-1brush-2paint-v01-transfer-learning-tensorflow-lite-float32-model.5.tflite">
    <button id="urlBtn">Load From URL</button>
  </div>

  <button id="startCamBtn">Start Webcam</button>
  <button id="resetBtn">Reset / Stop Webcam</button>
</div>

<video id="video" playsinline autoplay style="display:none"></video>
<canvas id="canvas" width="120" height="120"></canvas>

<script>
let model = null, video, canvas, ctx, reqId = null;
let cfg = {
  url: 'tflite/ei-ei-jeremy-0unknown-1brush-2paint-v01-transfer-learning-tensorflow-lite-float32-model.5.tflite',
  res: 120, ch: 3, labels: ['background', 'brush', 'paint'], th: 0.7
};

const $ = id => document.getElementById(id);
const setStatus = t => $('status').textContent = t;

$('applyBtn').onclick = () => {
  cfg.res = parseInt($('res').value) || 120;
  cfg.ch = parseInt($('ch').value) || 3;
  cfg.th = parseFloat($('th').value) || 0.7;
  cfg.labels = $('labels').value.split(',').map(s => s.trim());
  $('canvas').width = $('canvas').height = cfg.res;
  setStatus(`Applied: ${cfg.res}px, ${cfg.ch}ch, ${cfg.labels.length} classes`);
};

$('defaultBtn').onclick = () => loadModel(cfg.url);
$('urlBtn').onclick = () => loadModel($('urlInput').value.trim());
$('fileInput').onchange = handleFileInput;
$('startCamBtn').onclick = startWebcam;
$('resetBtn').onclick = resetApp;

async function handleFileInput(e) {
  const file = e.target.files[0];
  if (!file) return;
  stopLoop();
  setStatus(`Loading local model: ${file.name} ...`);
  try {
    const blobUrl = URL.createObjectURL(file);
    model = await tflite.loadTFLiteModel(blobUrl);
    URL.revokeObjectURL(blobUrl);
    setStatus(`‚úÖ Loaded: ${file.name}. You can now click "Start Webcam"`);
  } catch (err) {
    console.error(err);
    setStatus(`‚ùå Failed to load model file: ${file.name}`);
  }
}

async function loadModel(src) {
  stopLoop();
  setStatus('Loading model...');
  try {
    model = await tflite.loadTFLiteModel(src);
    setStatus('‚úÖ Model loaded. You can now click "Start Webcam".');
  } catch (e) {
    console.error(e);
    setStatus('‚ùå Model load failed (see console)');
  }
}

async function startWebcam() {
  video = $('video');
  canvas = $('canvas');
  ctx = canvas.getContext('2d');
  try {
    const stream = await navigator.mediaDevices.getUserMedia({
      video: { width: cfg.res, height: cfg.res, facingMode: 'user' }, audio: false
    });
    video.srcObject = stream;
    await video.play();
    setStatus(model ? 'üé• Webcam running, classifying...' : 'üé• Webcam running (no model loaded)');
    runLoop();
  } catch (e) {
    console.error(e);
    setStatus('‚ùå Webcam access denied or not available');
  }
}

function runLoop() {
  if (!model) return;
  tf.tidy(async () => {
    ctx.drawImage(video, 0, 0, cfg.res, cfg.res);
    let x = tf.browser.fromPixels(canvas, cfg.ch).div(255).expandDims(0);
    const output = await model.predict(x);
    const data = output.dataSync();
    drawResult(data);
  });
  reqId = requestAnimationFrame(runLoop);
}

function drawResult(scores) {
  if (!scores || scores.length === 0) return;
  let maxI = scores.indexOf(Math.max(...scores));
  let label = cfg.labels[maxI] || 'unknown';
  let conf = scores[maxI];
  ctx.fillStyle = 'rgba(0,0,0,0.7)';
  ctx.fillRect(0, cfg.res - 40, cfg.res, 40);
  ctx.fillStyle = conf >= cfg.th ? 'lime' : 'yellow';
  ctx.font = 'bold 16px Inter';
  ctx.textAlign = 'center';
  ctx.fillText(`${label} ${(conf * 100).toFixed(1)}%`, cfg.res / 2, cfg.res - 15);
}

function stopLoop() {
  if (reqId) cancelAnimationFrame(reqId), reqId = null;
  if (video?.srcObject) {
    video.srcObject.getTracks().forEach(t => t.stop());
    video.srcObject = null;
  }
}

function resetApp() {
  stopLoop();
  model = null;
  if (!ctx) ctx = $('canvas').getContext('2d');
  ctx.clearRect(0, 0, cfg.res, cfg.res);
  setStatus('üîÅ Reset. Configure and reload model.');
}
</script>
</body>
</html>

</html>
